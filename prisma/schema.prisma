generator client {
  provider      = "prisma-client-js"
  engineType    = "node-api"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DeckDifficulty {
  EASY
  MEDIUM
  HARD
}

enum BloomLevel {
  REMEMBER
  UNDERSTAND
  APPLY
  ANALYZE
  EVALUATE
  CREATE
}

enum FlashcardDifficulty {
  VERY_EASY
  EASY
  MEDIUM
  HARD
  VERY_HARD
}

model User {
  id            String   @id
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  surname       String?
  favColor      String?
  bio           String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions        Session[]
  accounts        Account[]
  decks           Deck[]
  flashcards      Flashcard[]
  reminders       Reminder[]
  aIGeneratedCard AIGeneratedCard[]
  userStats       UserStats?
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model UserStats {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  flashcardsCreated     Int       @default(0)
  decksCount            Int       @default(0)
  studiesCompleted      Int       @default(0)
  accuracyRate          Float     @default(0.0)
  lastStudyAt           DateTime?
  studyStreak           Int       @default(0)
  mostStudiedCategories String[]  @default([])
  averageEaseFactor     Float?    @default(2.5)
  averageInterval       Float?    @default(0.0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_stats")
}

model Deck {
  id            String          @id @default(cuid())
  name          String
  description   String?
  color         String?
  tags          String[]
  reviewCount   Int?            @default(0)
  difficulty    DeckDifficulty?
  lastStudiedAt DateTime?
  deletedAt     DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id])

  flashcards      Flashcard[]
  aIGeneratedCard AIGeneratedCard[]

  @@map("deck")
}

model Flashcard {
  id         String               @id @default(cuid())
  front      String
  back       String
  topic      String?
  subtopic   String?
  difficulty FlashcardDifficulty?
  bloomLevel BloomLevel?

  color String?

  note          String?
  userId        String
  deckId        String?
  generatedById String?

  user        User             @relation(fields: [userId], references: [id])
  deck        Deck?            @relation(fields: [deckId], references: [id])
  generatedBy AIGeneratedCard? @relation("AIGeneratedToFlashcards", fields: [generatedById], references: [id])

  // spaced repetition
  easeFactor     Float     @default(2.5)
  interval       Int       @default(1)
  repetition     Int       @default(0)
  nextReview     DateTime?
  lastReviewedAt DateTime?
  performanceAvg Float?    @default(0.0)

  reviews   FlashcardReview[]
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  deletedAt DateTime?

  @@map("flashcard")
}

model FlashcardReview {
  id           String    @id @default(cuid())
  flashcardId  String
  flashcard    Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)
  grade        Int
  reviewedAt   DateTime  @default(now())
  timeToAnswer Int?
  notes        String?
  createdAt    DateTime  @default(now())

  @@map("flashcard_review")
}

model AIGeneratedCard {
  id                  String      @id @default(cuid())
  prompt              String
  response            Json
  accepted            Boolean     @default(false)
  edited              Boolean     @default(false)
  generatedFlashcards Flashcard[] @relation("AIGeneratedToFlashcards")

  userId String
  deckId String?

  user User  @relation(fields: [userId], references: [id])
  deck Deck? @relation(fields: [deckId], references: [id])

  createdAt DateTime @default(now())

  @@map("ai_generated_card")
}

model Reminder {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  message   String
  sendAt    DateTime
  sent      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("reminder")
}
