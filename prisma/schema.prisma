generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum DeckDifficulty {
  EASY
  MEDIUM
  HARD
}

enum BloomLevel {
  REMEMBER
  UNDERSTAND
  APPLY
  ANALYZE
  EVALUATE
  CREATE
}

enum FlashcardDifficulty {
  VERY_EASY
  EASY
  MEDIUM
  HARD
  VERY_HARD
}

enum GenerationModel {
  SIMPLE
  DETAILED
  QUIZ
  EXPLAINED
}

enum ActivityType {
  CREATE_DECK
  UPDATE_DECK
  DELETE_DECK

  CREATE_FLASHCARD
  UPDATE_FLASHCARD
  DELETE_FLASHCARD

  CREATE_FLASHCARD_BY_AI

  REVIEW_FLASHCARD
  STUDY_SESSION_STARTED
  STUDY_SESSION_COMPLETED

  CREATE_QUIZ
  ANSWER_QUIZ
  DELETE_QUIZ

  CREATE_OPEN_QUESTION
  ANSWER_OPEN_QUESTION
  DELETE_OPEN_QUESTION

  OTHER
}

enum OpenStudyStatus {
  COMPLETED
  PENDING
}

enum QuizDifficulty {
  EASY
  MEDIUM
  HARD
}

enum QuizStyle {
  DIRECT
  REAL_SCENARIO
  TRICKY
  EXAM_LEVEL
}

enum ExplanationType {
  SHORT
  DETAILED
  ANALOGY
  PRACTICAL
}

enum QuizStepType {
  CONCEPT
  EXAMPLE
  COMPARISON
  APPLICATION
}

enum QuizStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

model User {
  id            String   @id
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  surname       String?
  favColor      String?
  bio           String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions             Session[]
  accounts             Account[]
  decks                Deck[]
  flashcards           Flashcard[]
  reminders            Reminder[]
  aIGeneratedCard      AIGeneratedCard[]
  userStats            UserStats?
  studySessions        StudySession[]
  activityLogs         ActivityLog[]
  openStudySessions    OpenStudySession[]
  quizSessions         QuizSession[]
  dailyStudyActivities DailyStudyActivity[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model UserStats {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  decksCount            Int       @default(0)
  flashcardsCreated     Int       @default(0)
  studiesCompleted      Int       @default(0)
  totalReviews          Int       @default(0)
  totalStudyTime        Int       @default(0)
  accuracyRateCards     Float     @default(0.0)
  totalCorrectAnswers   Int       @default(0)
  totalWrongAnswers     Int       @default(0)
  lastStudyAt           DateTime?
  mostStudiedCategories Json[]
  mostStudiedBloomLevel Json[]
  openStudyCount        Int       @default(0)
  openScoreSum          Int       @default(0)
  openAverageScore      Float     @default(0.0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_stats")
}

model DailyStudyActivity {
  id     String   @id @default(cuid())
  userId String
  date   DateTime @db.Date
  count  Int      @default(0) // quantas ações de estudo foram feitas no dia
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}

model Deck {
  id            String          @id @default(cuid())
  name          String
  description   String?
  color         String?
  tags          String[]
  reviewCount   Int?            @default(0)
  difficulty    DeckDifficulty?
  lastStudiedAt DateTime?
  deletedAt     DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  flashcards      Flashcard[]
  aIGeneratedCard AIGeneratedCard[]
  studySessions   StudySession[]

  @@map("deck")
}

model Flashcard {
  id         String               @id @default(cuid())
  front      String
  back       String
  topic      String?
  subtopic   String?
  difficulty FlashcardDifficulty?
  bloomLevel BloomLevel?

  color String?

  note          String?
  userId        String
  deckId        String
  generatedById String?

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  deck        Deck             @relation(fields: [deckId], references: [id], onDelete: Cascade)
  generatedBy AIGeneratedCard? @relation("AIGeneratedToFlashcards", fields: [generatedById], references: [id])

  // spaced repetition
  easeFactor     Float     @default(2.5)
  interval       Int       @default(1)
  repetition     Int       @default(0)
  nextReview     DateTime?
  lastReviewedAt DateTime?
  performanceAvg Float?    @default(0.0)

  reviews           FlashcardReview[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  deletedAt         DateTime?
  sessionId         String?
  sessionFlashcards SessionFlashcard[]

  @@map("flashcard")
}

model AIGeneratedCard {
  id                  String      @id @default(cuid())
  prompt              String
  response            Json
  accepted            Boolean     @default(false)
  edited              Boolean     @default(false)
  generatedFlashcards Flashcard[] @relation("AIGeneratedToFlashcards")

  userId String
  deckId String?

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  deck Deck? @relation(fields: [deckId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("ai_generated_card")
}

model StudySession {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  deckId String
  deck   Deck   @relation(fields: [deckId], references: [id], onDelete: Cascade)

  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  completed    Boolean   @default(false)
  currentIndex Int       @default(0)
  correctCount Int       @default(0)
  wrongCount   Int       @default(0)

  flashcardReviews  FlashcardReview[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  sessionFlashcards SessionFlashcard[]
}

model FlashcardReview {
  id           String        @id @default(cuid())
  flashcardId  String
  flashcard    Flashcard     @relation(fields: [flashcardId], references: [id], onDelete: Cascade)
  sessionId    String?
  session      StudySession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  grade        Int
  reviewedAt   DateTime      @default(now())
  timeToAnswer Int?
  notes        String?
  createdAt    DateTime      @default(now())

  @@map("flashcard_review")
}

model UserTagCount {
  id     String @id @default(cuid())
  userId String
  tag    String
  count  Int    @default(0)

  @@unique([userId, tag])
  @@map("user_tag_count")
}

model ActivityLog {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    ActivityType
  icon    String
  message String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@map("activity_log")
}

model SessionFlashcard {
  id          String   @id @default(cuid())
  sessionId   String
  flashcardId String
  createdAt   DateTime @default(now())

  session   StudySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  flashcard Flashcard    @relation(fields: [flashcardId], references: [id], onDelete: Cascade)

  @@unique([sessionId, flashcardId])
  @@index([sessionId])
  @@index([flashcardId])
}

model OpenStudySession {
  id          String             @id @default(cuid())
  userId      String
  topic       String
  createdAt   DateTime           @default(now())
  completedAt DateTime?
  status      OpenStudyStatus    @default(PENDING)
  user        User               @relation(fields: [userId], references: [id])
  question    OpenQuestion?
  attempt     OpenAnswerAttempt?
}

model OpenQuestion {
  id          String   @id @default(cuid())
  sessionId   String   @unique
  content     String // a pergunta gerada pela IA
  idealAnswer String? // resposta modelo da IA (opcional)
  difficulty  String? // easy / medium / hard
  createdAt   DateTime @default(now())

  session OpenStudySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model OpenAnswerAttempt {
  id            String   @id @default(cuid())
  sessionId     String   @unique
  userAnswer    String // texto do usuário
  score         Int // 0–100
  feedback      String // feedback da IA
  missingPoints String? // itens faltantes
  createdAt     DateTime @default(now())

  session OpenStudySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model Reminder {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  message   String
  sendAt    DateTime
  sent      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("reminder")
}

model QuizSession {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  topic           String
  subtopic        String?
  difficulty      QuizDifficulty
  style           QuizStyle
  explanationType ExplanationType
  status          QuizStatus      @default(ABANDONED)

  mode String @default("EVOLUTION") // sempre modo evolução

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  steps QuizStep[]
}

model QuizStep {
  id        String      @id @default(cuid())
  sessionId String
  session   QuizSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  stepType QuizStepType // conceito → exemplo → comparação → aplicação
  question QuizQuestion?

  userAnswerId String?
  userAnswer   QuizOption? @relation("UserAnswer", fields: [userAnswerId], references: [id], onDelete: Cascade)
  answeredAt   DateTime?
  isCorrect    Boolean?

  createdAt DateTime?
}

model QuizQuestion {
  id     String   @id @default(cuid())
  stepId String   @unique
  step   QuizStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  content String // texto da pergunta

  options     QuizOption[]
  explanation QuizExplanation?
}

model QuizOption {
  id         String       @id @default(cuid())
  questionId String
  question   QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  text      String
  isCorrect Boolean @default(false)

  // usado para ligar a resposta do usuário
  QuizStep QuizStep[] @relation("UserAnswer")
}

model QuizExplanation {
  id         String       @id @default(cuid())
  questionId String       @unique
  question   QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  text String // explicação da IA
  type ExplanationType

  createdAt DateTime @default(now())
}

model Jwks {
  id         String   @id
  publicKey  String
  privateKey String
  createdAt  DateTime

  @@map("jwks")
}
